

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Geometric Models &mdash; OpenSfM 0.5.2 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="_static/mathjax_conf.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Camera Coordinate System and Conventions" href="cam_coord_system.html" />
    <link rel="prev" title="Dataset Structure" href="dataset.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> OpenSfM
          

          
          </a>

          
            
            
              <div class="version">
                0.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="building.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="using.html">Using</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset.html">Dataset Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset.html#reconstruction-file-format">Reconstruction file format</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Geometric Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#coordinate-systems">Coordinate Systems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#normalized-image-coordinates">Normalized Image Coordinates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pixel-coordinates">Pixel Coordinates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upright-coordinates">Upright Coordinates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#world-coordinates">World Coordinates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#camera-coordinates">Camera Coordinates</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#camera-models">Camera Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#perspective-camera">Perspective Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-radial-camera">Simple Radial Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="#radial-camera">Radial Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="#brown-camera">Brown Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fisheye-camera">Fisheye Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fisheye-62">Fisheye 62</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fisheye-opencv">Fisheye OpenCV</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spherical-camera">Spherical Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dual-camera">Dual Camera</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cam_coord_system.html">Camera Coordinate System and Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="reconstruction_module.html">Incremental reconstruction algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="large.html">Splitting a large dataset into smaller submodels</a></li>
<li class="toctree-l1"><a class="reference internal" href="reporting.html">Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="quality_report.html">Statistics and Quality Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="rig.html">Rig Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="annotation_tool.html">Control points annotation tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Code Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OpenSfM</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Geometric Models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/mapillary/OpenSfM/blob/main/doc/source/geometry.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="geometric-models">
<h1>Geometric Models<a class="headerlink" href="#geometric-models" title="Permalink to this headline">¶</a></h1>
<div class="section" id="coordinate-systems">
<h2>Coordinate Systems<a class="headerlink" href="#coordinate-systems" title="Permalink to this headline">¶</a></h2>
<div class="section" id="normalized-image-coordinates">
<span id="id1"></span><h3>Normalized Image Coordinates<a class="headerlink" href="#normalized-image-coordinates" title="Permalink to this headline">¶</a></h3>
<p>The 2d position of a point in images is stored in what we will call <em>normalized image coordinates</em>.  The origin is in the middle of the image.  The x coordinate grows to the right and y grows downwards.  The larger dimension of the image is 1.</p>
<p>This means, for example, that all the pixels in an image with aspect ratio 4:3 will be contained in the intervals <code class="docutils literal notranslate"><span class="pre">[-0.5,</span> <span class="pre">0.5]</span></code> and <code class="docutils literal notranslate"><span class="pre">[3/4</span> <span class="pre">*</span> <span class="pre">(-0.5),</span> <span class="pre">3/4</span> <span class="pre">*</span> <span class="pre">0.5]</span></code> for the X and Y axis respectively.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+-----------------------------+</span>
<span class="o">|</span>                             <span class="o">|</span>
<span class="o">|</span>                             <span class="o">|</span>
<span class="o">|</span>                             <span class="o">|</span>
<span class="o">|</span>              <span class="o">+</span> <span class="o">-------------&gt;</span>
<span class="o">|</span>              <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>       <span class="o">|</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">|</span>              <span class="o">|</span>              <span class="o">|</span>
<span class="o">|</span>              <span class="o">|</span>              <span class="o">|</span>
<span class="o">+-----------------------------+</span>
               <span class="o">|</span>
               <span class="n">v</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p>Normalized coordinates are independent of the resolution of the image and give better numerical stability for some multi-view geometry algorithms than pixel coordinates.</p>
</div>
<div class="section" id="pixel-coordinates">
<span id="id2"></span><h3>Pixel Coordinates<a class="headerlink" href="#pixel-coordinates" title="Permalink to this headline">¶</a></h3>
<p>Many OpenCV functions that work with images use <em>pixel coordinates</em>.  In that reference frame, the origin is at the center of the top-left pixel, x grow by one for every pixel to the right and y grows by one for every pixel downwards.  The bottom-right pixel is therefore at <code class="docutils literal notranslate"><span class="pre">(width</span> <span class="pre">-</span> <span class="pre">1,</span> <span class="pre">height</span> <span class="pre">-</span> <span class="pre">1)</span></code>.</p>
<p>The transformation from normalised image coordinates to pixel coordinates is</p>
<div class="math notranslate nohighlight">
\[\begin{split}H = \begin{pmatrix}
         \max(w, h) &amp; 0 &amp; \frac{w-1}{2} \\
         0 &amp; \max(w, h) &amp; \frac{h-1}{2} \\
         0 &amp; 0 &amp; 1
     \end{pmatrix},\end{split}\]</div>
<p>and its inverse</p>
<div class="math notranslate nohighlight">
\[\begin{split}H^{-1} = \begin{pmatrix}
         1 &amp; 0 &amp; -\frac{w-1}{2} \\
         0 &amp; 1 &amp; -\frac{h-1}{2} \\
         0 &amp; 0 &amp; \max(w, h)
     \end{pmatrix},\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(w\)</span> and <span class="math notranslate nohighlight">\(h\)</span> being the width and height of the image.</p>
</div>
<div class="section" id="upright-coordinates">
<h3>Upright Coordinates<a class="headerlink" href="#upright-coordinates" title="Permalink to this headline">¶</a></h3>
<p>When taking pictures, a camera might be rotated in either portrait or in landscape orientation. But the corresponding image file will always store the pixels in the same order, the one when the camera is supposed to be upright.</p>
<p>To overcome this issue, most camera store this orientation (i.e. camera orientation at shoot time) in the EXIFs in the <cite>orientation</cite> tag. Most editing software will also use this information to display image correctly.</p>
<p>That’s why, when editing a mask with your favorite software, you don’t need to bother about image orientation as OpenSfM will automatically apply the right rotation correction so your mask will be aligned with the original image.</p>
<p>Please note that <cite>Normalized Image Coordinates</cite> and <cite>Pixel Coordinates</cite> are <em>NOT</em> corrected for upright, and are really <em>original</em> image coordinates.</p>
</div>
<div class="section" id="world-coordinates">
<h3>World Coordinates<a class="headerlink" href="#world-coordinates" title="Permalink to this headline">¶</a></h3>
<p>The position of the reconstructed 3D points is stored in <em>world coordinates</em>.  In general, this is an arbitrary euclidean reference frame.</p>
<p>When GPS data is available, a topocentric reference frame is used for the world coordinates reference.  This is a reference frame that with the origin somewhere near the ground, the X axis pointing to the east, the Y axis pointing to the north and the Z axis pointing to the zenith.  The latitude, longitude, and altitude of the origin are stored in the <code class="docutils literal notranslate"><span class="pre">reference_lla.json</span></code> file.</p>
<p>When GPS data is not available, the reconstruction process makes its best to rotate the world reference frame so that the vertical direction is Z and the ground is near the <cite>z = 0</cite> plane.  It does so by assuming that the images are taken from similar altitudes and that the up vector of the images corresponds to the up vector of the world.</p>
</div>
<div class="section" id="camera-coordinates">
<h3>Camera Coordinates<a class="headerlink" href="#camera-coordinates" title="Permalink to this headline">¶</a></h3>
<p>The <em>camera coordinate</em> reference frame has the origin at the camera’s optical center, the X axis is pointing to the right of the camera the Y axis is pointing down and the Z axis is pointing to the front.  A point in front of the camera has positive Z camera coordinate.</p>
<p>The pose of a camera is determined by the rotation and translation that converts world coordinates to camera coordinates.</p>
</div>
</div>
<div class="section" id="camera-models">
<h2>Camera Models<a class="headerlink" href="#camera-models" title="Permalink to this headline">¶</a></h2>
<p>The camera models deal with the projection of 3D points expressed in <em>camera coordinates</em> <code class="docutils literal notranslate"><span class="pre">x,</span> <span class="pre">y,</span> <span class="pre">z</span></code> into points <code class="docutils literal notranslate"><span class="pre">u,</span> <span class="pre">v</span></code> in <em>normalized image coordinates</em>.</p>
<div class="section" id="perspective-camera">
<h3>Perspective Camera<a class="headerlink" href="#perspective-camera" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>perspective</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
x_n = \frac{x}{z} \\
y_n = \frac{y}{z} \\
r^2 = x_n^2 + y_n^2 \\
d = 1 + k_1 r^2 + k_2 r^4 \\
u = f\ d\ x_n \\
v = f\ d\ y_n
\end{array}\end{split}\]</div>
</div>
<div class="section" id="simple-radial-camera">
<h3>Simple Radial Camera<a class="headerlink" href="#simple-radial-camera" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>simple_radial</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
x_n = \frac{x}{z} \\
y_n = \frac{y}{z} \\
r^2 = x_n^2 + y_n^2 \\
d = 1 + k_1 r^2\\
u = f_x\ d\ x_n + cx \\
v = f_y\ d\ y_n + cy
\end{array}\end{split}\]</div>
</div>
<div class="section" id="radial-camera">
<h3>Radial Camera<a class="headerlink" href="#radial-camera" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>radial</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
x_n = \frac{x}{z} \\
y_n = \frac{y}{z} \\
r^2 = x_n^2 + y_n^2 \\
d = 1 + k_1 r^2 + k_2 r^4\\
u = f_x\ d\ x_n + c_x \\
v = f_y\ d\ y_n + c_y
\end{array}\end{split}\]</div>
</div>
<div class="section" id="brown-camera">
<h3>Brown Camera<a class="headerlink" href="#brown-camera" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>brown</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
x_n = \frac{x}{z} \\
y_n = \frac{y}{z} \\
r^2 = x_n^2 + y_n^2 \\
d_r = 1 + k_1 r^2 + k_2 r^4 + k_3 r^6\\
d^t_x = 2p_1\ x_n\ y_n + p_2\ (r^2 + 2x)\\
d^t_y = 2p_2\ x_n\ y_n + p_1\ (r^2 + 2y)\\
u = f_x\ (d_r\ x_n + d^t_x) + c_x \\
v = f_y\ (d_r\ y_n + d^t_y) + c_y
\end{array}\end{split}\]</div>
</div>
<div class="section" id="fisheye-camera">
<h3>Fisheye Camera<a class="headerlink" href="#fisheye-camera" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>fisheye</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
r^2 = x^2 + y^2 \\
\theta = \arctan(r / z) \\
d = 1 +  k_1 \theta^2+  k_2 \theta^4 \\
u = f\ d\ \theta\ \frac{x}{r} \\
v = f\ d\ \theta\ \frac{y}{r}
\end{array}\end{split}\]</div>
</div>
<div class="section" id="fisheye-62">
<h3>Fisheye 62<a class="headerlink" href="#fisheye-62" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>fisheye62</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
r^2 = x^2 + y^2 \\
\theta = \arctan(r / z) \\
d_r = 1 + k_1\theta + k_2\theta^2 + k_3\theta^3 + k_4\theta^4 + k_5\theta^5 + k_6\theta^6\\
d^t_x = 2p_1\ x_n\ y_n + p_2\ (r^2 + 2x)\\
d^t_y = 2p_2\ x_n\ y_n + p_1\ (r^2 + 2y)\\
u = f\ (d_r\ \theta\ \frac{x}{r} + d^t_x) + c_x \\
v = f\ (d_r\ \theta\ \frac{y}{r} + d^t_y) + c_y
\end{array}\end{split}\]</div>
</div>
<div class="section" id="fisheye-opencv">
<h3>Fisheye OpenCV<a class="headerlink" href="#fisheye-opencv" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>fisheye_opencv</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
r^2 = x^2 + y^2 \\
\theta = \arctan(r / z) \\
d_r = 1 + k_1\theta^2 + k_2\theta^4 + k_3\theta^6\\
d^t_x = 2p_1\ x_n\ y_n + p_2\ (r^2 + 2x)\\
d^t_y = 2p_2\ x_n\ y_n + p_1\ (r^2 + 2y)\\
u = f\ (d\ \theta\ \frac{x}{r} + d^t_x) + c_x \\
v = f\ (d\ \theta\ \frac{y}{r} + d^t_y) + c_y
\end{array}\end{split}\]</div>
</div>
<div class="section" id="spherical-camera">
<h3>Spherical Camera<a class="headerlink" href="#spherical-camera" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>spherical</cite> or <cite>equirectangular</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
\mathrm{lon} = \arctan\left(\frac{x}{z}\right) \\
\mathrm{lat} = \arctan\left(\frac{-y}{\sqrt{x^2 + z^2}}\right) \\
u = \frac{\mathrm{lon}}{2 \pi} \\
v = -\frac{\mathrm{lat}}{2 \pi}
\end{array}\end{split}\]</div>
</div>
<div class="section" id="dual-camera">
<h3>Dual Camera<a class="headerlink" href="#dual-camera" title="Permalink to this headline">¶</a></h3>
<p>Identifier <cite>dual</cite></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{l}
r^2 = x^2 + y^2 \\
x^n_p = \frac{x}{z} \\
y^n_p = \frac{y}{z} \\
x^n_f = theta\ \frac{x}{r} \\
y^n_f = theta\ \frac{y}{r} \\
d = 1 + k_1\theta^2 + k_2\theta^4 \\
u = f\ d\ (l\ x^n_p\ + (1-l)\ x^n_f) \\
v = f\ d\ (l\ y^n_p\ + (1-l)\ y^n_f)
\end{array}\end{split}\]</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="cam_coord_system.html" class="btn btn-neutral float-right" title="Camera Coordinate System and Conventions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dataset.html" class="btn btn-neutral float-left" title="Dataset Structure" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Mapillary.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 
<style>
  @import url('https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700&display=swap');
  html {
    font-family: 'Source Sans Pro', sans-serif;
  }
  .highlight {
    font-family: "Lucida Console", Monaco, monospace!important;
  }
  .wy-side-nav-search {
    background: #212b36;
  }
  .wy-side-nav-search input[type=text] {
    border-color: transparent;
    
  }
  .wy-nav-side {
    background: #212b36;
  }
  .wy-menu-vertical a:hover {
    color: #d9d9d9;
    background: rgba(255, 255, 255, 0.1);
  }
  a, a:hover {
    color: #05cb63;
  }
  body {
    color: #212b36;
  }
  .wy-nav-content-wrap {
    background: #fcfcfc!important;
  }
  .wy-side-nav-search>a:hover {
    color: #fff!important;
  }
  .highlight {
    background: #dee5ed;
  }
  .wy-menu-vertical li.on a, .wy-menu-vertical li.current>a {

  }
  .wy-menu-vertical li.toctree-l1.current>a {
    border-top: 0;
    border-bottom: 0;
  }
  .rst-content pre.literal-block, .rst-content div[class^='highlight'] {
    border-radius: 4px;
    border-color: #dee5ed!important;  
  }
</style>


</body>
</html>